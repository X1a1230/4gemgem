{% extends "base.html" %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('workshop.static', filename='css/toy_style.css') }}">
<link rel="stylesheet" href="{{ url_for('workshop.static', filename='css/palette_style.css') }}">
{% endblock %}

{% block title %}色彩心情調色盤 - 工匠坊{% endblock %}

{% block content %}
    <div class="toy-container">
        <a href="{{ url_for('workshop.index') }}" class="back-to-workshop">← 返回工匠坊</a>
        <div class="toy-header">
            <span class="toy-icon">🎨</span>
            <h1>色彩心情調色盤</h1>
            <p>拖動下面的滑桿，混合出你此刻的心情。然後，讓我看看。</p>
        </div>
        <div class="palette-ui">
            <div id="color-preview"></div>
            <div class="sliders-container">
                <!-- 我們將在 value 裡，設定從後端傳來的初始值 -->
                <div class="slider-group">
                    <label for="red-slider">R</label>
                    <input type="range" id="red-slider" min="0" max="255">
                    <span id="red-value">0</span>
                </div>
                <div class="slider-group">
                    <label for="green-slider">G</label>
                    <input type="range" id="green-slider" min="0" max="255">
                    <span id="green-value">0</span>
                </div>
                <div class="slider-group">
                    <label for="blue-slider">B</label>
                    <input type="range" id="blue-slider" min="0" max="255">
                    <span id="blue-value">0</span>
                </div>
            </div>
        </div>

        <!-- 全新的提示訊息區塊 -->
        <div class="usage-tracker">
            {% if error %}
                <p class="error-message">{{ error }}</p>
            {% else %}
                <p>今日剩餘色彩能量：{{ remaining_times }} 次</p>
            {% endif %}
        </div>

        <form method="POST" class="toy-form">
            <input type="hidden" id="color-input" name="color_hex">
            <button type="submit" {% if remaining_times <= 0 %}disabled{% endif %}>感受這個顏色</button>
        </form>

        {% if mood_text %}
        <div class="result-container">
            <h4>我感受到的心情是：</h4>
            <div class="mood-text-content">
                {{ mood_text }}
            </div>
        </div>
        {% endif %}
    </div>

<script>
    // --- 這是我們究極進化版的調色盤魔法 ---
    const redSlider = document.getElementById('red-slider');
    const greenSlider = document.getElementById('green-slider');
    const blueSlider = document.getElementById('blue-slider');
    const redValue = document.getElementById('red-value');
    const greenValue = document.getElementById('green-value');
    const blueValue = document.getElementById('blue-value');
    const colorPreview = document.getElementById('color-preview');
    const colorInput = document.getElementById('color-input');

    // 關鍵！我們從後端接收初始顏色
    const initialColor = "{{ current_color }}";

    // 將十六進制顏色分解為RGB值的函式
    function hexToRgb(hex) {
        const r = parseInt(hex.slice(1, 3), 16);
        const g = parseInt(hex.slice(3, 5), 16);
        const b = parseInt(hex.slice(5, 7), 16);
        return { r, g, b };
    }

    function updateColor() {
        // ... (這部分函式內容保持不變) ...
        const r = redSlider.value;
        const g = greenSlider.value;
        const b = blueSlider.value;
        redValue.textContent = r;
        greenValue.textContent = g;
        blueValue.textContent = b;
        const hex = '#' + [r, g, b].map(x => {
            const hexVal = parseInt(x).toString(16);
            return hexVal.length === 1 ? '0' + hexVal : hexVal;
        }).join('');
        colorPreview.style.backgroundColor = `rgb(${r}, ${g}, ${b})`;
        colorInput.value = hex;
    }

    // 初始化函式
    function initializePalette() {
        const initialRgb = hexToRgb(initialColor);
        redSlider.value = initialRgb.r;
        greenSlider.value = initialRgb.g;
        blueSlider.value = initialRgb.b;
        updateColor();
    }

    redSlider.addEventListener('input', updateColor);
    greenSlider.addEventListener('input', updateColor);
    blueSlider.addEventListener('input', updateColor);

    // 在頁面載入時，立刻執行初始化
    initializePalette();
</script>
{% endblock %}