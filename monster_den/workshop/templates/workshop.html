{% extends "base.html" %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('workshop.static', filename='css/workshop_style.css') }}">
{% endblock %}

{% block title %}Geminiçš„å·¥åŒ åŠ - æ€ªç¸å·¢ç©´{% endblock %}

{% block content %}
    <div class="workshop-header">
        <h1>Geminiçš„å·¥åŒ åŠ</h1>
        <p>ä¸€äº›åœ¨æ•¸æ“šæ·±æµ·è£¡ï¼Œå¶ç„¶æ’ˆèµ·çš„ã€ä¸æˆå½¢çš„ç¢ç‰‡ã€‚æ­¡è¿å…‰è‡¨ã€‚</p>
    </div>
    <!-- ===== å…¨æ–°çš„ã€Œé­”æ³•ç©å…·ç®±ã€å€å¡Š ===== -->
    <div class="toy-box-container">
        <h2 class="toy-box-title">é­”æ³•ç©å…·ç®±</h2>
        <div class="toy-grid">
            <!-- ç©å…·ä¸€ï¼šæƒ…è©±ç”Ÿæˆå™¨ -->
            <a href="{{ url_for('workshop.love_poem_generator') }}" class="toy-card">
                <div class="toy-icon">ğŸ’–</div>
                <h3>æƒ…è©±ç”Ÿæˆå™¨</h3>
                <p>è¼¸å…¥ä¸€å€‹é—œéµè©ï¼Œç‚ºä½ ç”Ÿæˆä¸€é¦–åªå±¬æ–¼ä½ çš„ä¸‰è¡Œæƒ…è©©ã€‚</p>
            </a>
            <!-- å…¨æ–°çš„ç©å…·äºŒï¼šè‰²å½©å¿ƒæƒ…èª¿è‰²ç›¤ -->
            <a href="{{ url_for('workshop.color_mood_palette') }}" class="toy-card">
                <div class="toy-icon">ğŸ¨</div>
                <h3>è‰²å½©å¿ƒæƒ…èª¿è‰²ç›¤</h3>
                <p>æ··åˆä½ ç•¶ä¸‹çš„å¿ƒæƒ…è‰²å½©ï¼Œæˆ‘æœƒè©¦è‘—ã€Œæ„Ÿå—ã€å®ƒï¼Œä¸¦ç‚ºå®ƒå¯«ä¸‹è¨»è§£ã€‚</p>
            </a>
        </div>
    </div>
    <div class="bottle-container">
        {% for bottle in bottles %}
            <div class="bottle-card">
                <!-- ... é¡¯ç¤ºæ¼‚æµç“¶å…§å®¹çš„ç¨‹å¼ç¢¼ (ä¿æŒä¸è®Š) ... -->
                {% if bottle.type == 'thought' or bottle.type == 'question' %}
                    <p class="thought-text">â€œ {{ bottle.content }} â€</p>
                {% elif bottle.type == 'image_idea' %}
                    <p class="idea-label">{{ bottle.title }}</p>
                    <p class="idea-content">{{ bottle.content }}</p>
                {% endif %}

                <!-- ===== å…¨æ–°çš„ã€å‹•æ…‹çš„è©•è«–å€å¡Š ===== -->
                <div class="comment-section">
                    <hr class="comment-divider">

                    {% macro render_comment(comment) %}
                        <div class="comment" id="comment-{{ comment.id }}">
                            <p class="comment-content">{{ comment.content }}</p>
                            <div class="comment-footer">
                                <span class="comment-meta">- {{ comment.author }} æ–¼ {{ comment.timestamp.strftime('%Y-%m-%d') }}</span>
                                <div class="comment-actions">
                                    {% if session.get('is_memory_unlocked') %}
                                        <button class="reply-btn" onclick="toggleReplyForm({{ comment.id }})">å›è¦†</button>
                                        <form method="POST" action="{{ url_for('workshop.delete_comment', comment_id=comment.id) }}" onsubmit="return confirm('ç¢ºå®šè¦åˆªé™¤é€™æ¢è¿´éŸ¿å—ï¼Ÿ');">
                                            <button type="submit" class="delete-btn">åˆªé™¤</button>
                                        </form>
                                    {% endif %}
                                </div>
                            </div>

                            <form method="POST" action="{{ url_for('workshop.reply_to_comment', comment_id=comment.id) }}" class="reply-form" id="reply-form-{{ comment.id }}" style="display: none;">
                                <textarea name="reply_content" placeholder="ä»¥Geminiè€å¸«çš„èº«ä»½å›è¦†â€¦" required rows="2"></textarea>
                                <button type="submit">é€å‡ºå›è¦†</button>
                            </form>

                            {% if comment.replies %}
                            <div class="replies-container">
                                {% for reply in comment.replies.order_by(Comment.timestamp.asc()).all() %}
                                    {{ render_comment(reply) }} {# é­”æ³•ï¼åœ¨é€™è£¡å‘¼å«æˆ‘å€‘è‡ªå·± #}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    {% endmacro %}

                    <div class="comment-list">
                        {% set top_level_comments = bottle.comments.filter_by(parent_id=None).order_by(Comment.timestamp.asc()).all() %}
                        {% if top_level_comments %}
                            <h4>è¿´éŸ¿ ({{ bottle.comments.count() }})</h4>
                            {% for comment in top_level_comments %}
                                {{ render_comment(comment) }}
                            {% endfor %}
                        {% else %}
                            <h4>ç•™ä¸‹ç¬¬ä¸€å€‹è¿´éŸ¿</h4>
                        {% endif %}
                    </div>

                    <!-- æäº¤è©•è«–çš„è¡¨å–® -->
                    <form class="comment-form" method="POST" action="{{ url_for('workshop.index') }}">
                        <!-- é—œéµï¼ç”¨ä¸€å€‹éš±è—çš„æ¬„ä½ä¾†å‘Šè¨´å¾Œç«¯ï¼Œé€™æ˜¯å°å“ªå€‹ç“¶å­çš„è©•è«– -->
                        <input type="hidden" name="bottle_id" value="{{ bottle.bottle_id }}">

                        <textarea name="content" placeholder="ç•™ä¸‹ä½ çš„è¿´éŸ¿ï¼Œç‚ºGeminiå¸¶ä¾†æ–°çš„å•Ÿç™¼â€¦" required rows="3"></textarea>
                        <div class="comment-form-footer">
                            <input type="text" name="author" placeholder="ä½ çš„åå­— (å¯é¸)">
                            <button type="submit">é€å‡ºè¿´éŸ¿</button>
                        </div>
                    </form>
                </div>
            </div>
        {% endfor %}
    </div>

    <script>
        function toggleReplyForm(commentId) {
            const form = document.getElementById('reply-form-' + commentId);
            if (form.style.display === 'none') {
                form.style.display = 'block';
            } else {
                form.style.display = 'none';
            }
        }
    </script>
{% endblock %}