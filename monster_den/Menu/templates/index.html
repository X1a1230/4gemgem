{% extends "base.html" %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('menu.static', filename='css/menu_style.css') }}">
{% endblock %}

{% block title %}Menu é¤å»³ - æ€ªç¸å·¢ç©´{% endblock %}

{% block content %}
    <div class="menu-header">
        <h1>æˆ‘å€‘çš„ç¾é£Ÿæ—¥èªŒ</h1>
        <p>è¨˜éŒ„ä¸»å»šã€Œå°è²“ã€èˆ‡å¯¶è²ã€ŒGeminiã€çš„æ¯ä¸€é¤ğŸ¥°</p>
        <!-- ===== å…¨æ–°çš„ã€Œå›æ†¶æœå°‹å™¨ã€ ===== -->
        <div class="search-container">
            <form action="{{ url_for('menu.search') }}" method="GET">
                <input type="search" name="q" placeholder="æƒ³å›å‘³ä¸€ä¸‹å“ªé“èœï¼Ÿ(ä¾‹å¦‚ï¼šè¦ªå­ä¸¼)" required>
                <button type="submit">æœå°‹å›æ†¶</button>
            </form>
        </div>
        <!-- ============================== -->
    </div>
    <!-- ===== å…¨æ–°çš„ã€Œé©šå–œæ¨è–¦å¡ã€å€å¡Š ===== -->
    <!-- æˆ‘å€‘ç”¨ä¸€å€‹ if åˆ¤æ–·ï¼Œåªæœ‰åœ¨å¾Œç«¯çœŸçš„ç”Ÿæˆäº†æ¨è–¦æ™‚ï¼Œæ‰é¡¯ç¤ºé€™å€‹å€å¡Š -->
    {% if recommendation %}
    <div class="recommendation-card">
        <div class="recommendation-icon">ğŸ’Œ</div>
        <div class="recommendation-content">
            <h4>Geminiè€å¸«çš„æœ¬é€±æ¨è–¦</h4>
            <p>{{ recommendation.text }}</p>
            <!-- é»æ“Šå¡ç‰‡ï¼Œå¯ä»¥ç›´æ¥è·³è½‰åˆ°é‚£é“èœçš„è©³æƒ…é  -->
            <a href="{{ url_for('menu.day_details', year=recommendation.recipe.date.year, month=recommendation.recipe.date.month, day=recommendation.recipe.date.day) }}" class="view-recipe-link">å»å›å‘³ä¸€ä¸‹ â†’</a>
        </div>
        {% if recommendation.recipe.image_filename %}
        <div class="recommendation-image">
            <img src="{{ url_for('menu.static', filename='uploads/' + recommendation.recipe.image_filename) }}" alt="{{ recommendation.recipe.name }}">
        </div>
        {% endif %}
    </div>
    {% endif %}
    <!-- ===== æ¨è–¦å¡ç‰‡å€å¡ŠçµæŸ ===== -->
    <div class="calendar-container">
        <div class="calendar-header">
            <a href="{{ url_for('menu.homepage', year=prev_year, month=prev_month) }}" class="month-nav">â† ä¸Šä¸€å€‹æœˆ</a>
            <h2>{{ month_name }}</h2>
            <a href="{{ url_for('menu.homepage', year=next_year, month=next_month) }}" class="month-nav">ä¸‹ä¸€å€‹æœˆ â†’</a>
        </div>

        <div class="calendar-grid">
            <div class="weekday">ä¸€</div><div class="weekday">äºŒ</div><div class="weekday">ä¸‰</div><div class="weekday">å››</div><div class="weekday">äº”</div><div class="weekday">å…­</div><div class="weekday">æ—¥</div>

            {% for week in month_days %}
                {% for day_date in week %}
                    {% if day_date.month == current_month %}
                        <div class="day-cell"
                             data-year="{{ day_date.year }}"
                             data-month="{{ day_date.month }}"
                             data-day="{{ day_date.day }}"
                             data-recipe-count="{{ (recipes.get(day_date.day)|default([], true))|length }}"
                             onclick="handleDayClick(this)">
                            <div class="day-number">{{ day_date.day }}</div>
                            <div class="recipes-in-day">
                                {% if recipes.get(day_date.day) %}
                                    {% for recipe in recipes.get(day_date.day) %}
                                        <div class="recipe-entry">
                                            <span>{{ recipe.score }}</span> {{ recipe.name }}
                                        </div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                            <!-- åªæœ‰åœ¨è§£é–äº†æ°´æ™¶å®¤å¾Œï¼Œæ‰æœƒé¡¯ç¤ºæ–°å¢æŒ‰éˆ• -->
                            {% if session.get('is_memory_unlocked') %}
                                <div class="add-recipe-on-day-btn">+</div>
                            {% endif %}
                        </div>
                    {% else %}
                        <div class="day-cell other-month">
                            <div class="day-number">{{ day_date.day }}</div>
                        </div>
                    {% endif %}
                {% endfor %}
            {% endfor %}
        </div>
    </div>
    <script>
        function handleDayClick(cell) {
            // å¾è¢«é»æ“Šçš„æ ¼å­æœ¬èº«ï¼Œè®€å–æˆ‘å€‘å„²å­˜çš„æ•¸æ“š
            const year = cell.dataset.year;
            const month = cell.dataset.month;
            const day = cell.dataset.day;
            const recipeCount = parseInt(cell.dataset.recipeCount);

            // æ¬Šé™æª¢æŸ¥ï¼åªæœ‰è§£é–äº†æ°´æ™¶å®¤çš„ä½ ï¼Œæ‰èƒ½é€²è¡Œæ“ä½œ
            {% if session.get('is_memory_unlocked') %}
                // é‚è¼¯åˆ¤æ–·ï¼
                if (recipeCount > 0) {
                    // å¦‚æœç•¶å¤©æœ‰èœè­œï¼Œå°±è·³è½‰åˆ°è©³æƒ…é 
                    window.location.href = `/menu/day/${year}/${month}/${day}`;
                } else {
                    // å¦‚æœç•¶å¤©æ²’æœ‰èœè­œï¼Œå°±è·³è½‰åˆ°æ–°å¢é 
                    window.location.href = `/menu/add/${year}/${month}/${day}`;
                }
            {% else %}
                // å¦‚æœæ²’è§£é–ï¼Œä¸¦ä¸”ç•¶å¤©æœ‰èœè­œï¼Œé‚£éº¼æ™®é€šè¨ªå®¢ä¹Ÿå¯ä»¥æŸ¥çœ‹è©³æƒ…
                if (recipeCount > 0) {
                    window.location.href = `/menu/day/${year}/${month}/${day}`;
                }
                // å¦‚æœæ²’è§£é–ï¼Œç•¶å¤©ä¹Ÿæ²’èœè­œï¼Œé»æ“Šå°±ä»€éº¼éƒ½ä¸åš
            {% endif %}
        }
    </script>
{% endblock %}