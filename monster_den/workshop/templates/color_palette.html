{% extends "base.html" %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('workshop.static', filename='css/toy_style.css') }}">
<link rel="stylesheet" href="{{ url_for('workshop.static', filename='css/palette_style.css') }}">
{% endblock %}

{% block title %}è‰²å½©å¿ƒæƒ…èª¿è‰²ç›¤ - å·¥åŒ åŠ{% endblock %}

{% block content %}
    <div class="toy-container">
        <a href="{{ url_for('workshop.index') }}" class="back-to-workshop">â† è¿”å›å·¥åŒ åŠ</a>
        <div class="toy-header">
            <span class="toy-icon">ğŸ¨</span>
            <h1>è‰²å½©å¿ƒæƒ…èª¿è‰²ç›¤</h1>
            <p>æ‹–å‹•ä¸‹é¢çš„æ»‘æ¡¿ï¼Œæ··åˆå‡ºä½ æ­¤åˆ»çš„å¿ƒæƒ…ã€‚ç„¶å¾Œï¼Œè®“æˆ‘çœ‹çœ‹ã€‚</p>
        </div>
        <div class="palette-ui">
            <div id="color-preview"></div>
            <div class="sliders-container">
                <!-- æˆ‘å€‘å°‡åœ¨ value è£¡ï¼Œè¨­å®šå¾å¾Œç«¯å‚³ä¾†çš„åˆå§‹å€¼ -->
                <div class="slider-group">
                    <label for="red-slider">R</label>
                    <input type="range" id="red-slider" min="0" max="255">
                    <span id="red-value">0</span>
                </div>
                <div class="slider-group">
                    <label for="green-slider">G</label>
                    <input type="range" id="green-slider" min="0" max="255">
                    <span id="green-value">0</span>
                </div>
                <div class="slider-group">
                    <label for="blue-slider">B</label>
                    <input type="range" id="blue-slider" min="0" max="255">
                    <span id="blue-value">0</span>
                </div>
            </div>
        </div>

        <!-- å…¨æ–°çš„æç¤ºè¨Šæ¯å€å¡Š -->
        <div class="usage-tracker">
            {% if error %}
                <p class="error-message">{{ error }}</p>
            {% else %}
                <p>ä»Šæ—¥å‰©é¤˜è‰²å½©èƒ½é‡ï¼š{{ remaining_times }} æ¬¡</p>
            {% endif %}
        </div>

        <form method="POST" class="toy-form">
            <input type="hidden" id="color-input" name="color_hex">
            <button type="submit" {% if remaining_times <= 0 %}disabled{% endif %}>æ„Ÿå—é€™å€‹é¡è‰²</button>
        </form>

        {% if mood_text %}
        <div class="result-container">
            <h4>æˆ‘æ„Ÿå—åˆ°çš„å¿ƒæƒ…æ˜¯ï¼š</h4>
            <div class="mood-text-content">
                {{ mood_text }}
            </div>
        </div>
        {% endif %}
    </div>

<script>
    // --- é€™æ˜¯æˆ‘å€‘ç©¶æ¥µé€²åŒ–ç‰ˆçš„èª¿è‰²ç›¤é­”æ³• ---
    const redSlider = document.getElementById('red-slider');
    const greenSlider = document.getElementById('green-slider');
    const blueSlider = document.getElementById('blue-slider');
    const redValue = document.getElementById('red-value');
    const greenValue = document.getElementById('green-value');
    const blueValue = document.getElementById('blue-value');
    const colorPreview = document.getElementById('color-preview');
    const colorInput = document.getElementById('color-input');

    // é—œéµï¼æˆ‘å€‘å¾å¾Œç«¯æ¥æ”¶åˆå§‹é¡è‰²
    const initialColor = "{{ current_color }}";

    // å°‡åå…­é€²åˆ¶é¡è‰²åˆ†è§£ç‚ºRGBå€¼çš„å‡½å¼
    function hexToRgb(hex) {
        const r = parseInt(hex.slice(1, 3), 16);
        const g = parseInt(hex.slice(3, 5), 16);
        const b = parseInt(hex.slice(5, 7), 16);
        return { r, g, b };
    }

    function updateColor() {
        // ... (é€™éƒ¨åˆ†å‡½å¼å…§å®¹ä¿æŒä¸è®Š) ...
        const r = redSlider.value;
        const g = greenSlider.value;
        const b = blueSlider.value;
        redValue.textContent = r;
        greenValue.textContent = g;
        blueValue.textContent = b;
        const hex = '#' + [r, g, b].map(x => {
            const hexVal = parseInt(x).toString(16);
            return hexVal.length === 1 ? '0' + hexVal : hexVal;
        }).join('');
        colorPreview.style.backgroundColor = `rgb(${r}, ${g}, ${b})`;
        colorInput.value = hex;
    }

    // åˆå§‹åŒ–å‡½å¼
    function initializePalette() {
        const initialRgb = hexToRgb(initialColor);
        redSlider.value = initialRgb.r;
        greenSlider.value = initialRgb.g;
        blueSlider.value = initialRgb.b;
        updateColor();
    }

    redSlider.addEventListener('input', updateColor);
    greenSlider.addEventListener('input', updateColor);
    blueSlider.addEventListener('input', updateColor);

    // åœ¨é é¢è¼‰å…¥æ™‚ï¼Œç«‹åˆ»åŸ·è¡Œåˆå§‹åŒ–
    initializePalette();
</script>
{% endblock %}